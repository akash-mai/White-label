name: White Label Build
on:
  repository_dispatch:
    types: [rebrand_request]

jobs:
  build:
    runs-on: macos-latest  # macOS required for iOS IPA builds
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Setup Java (for keytool / Android signing)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET }}
          aws-region: us-east-1

      # ── 1. Download Brand Assets from S3 ──────────────────────────────────
      - name: Sync Brand Assets
        run: |
          mkdir -p branding_assets
          CLIENT_ID="${{ github.event.client_payload.client_id }}"
          S3_BASE="s3://${{ secrets.S3_BUCKET }}/brands/${CLIENT_ID}"

          # Required assets
          aws s3 cp "${S3_BASE}/logo.png"   branding_assets/logo.png
          aws s3 cp "${S3_BASE}/splash.png" branding_assets/splash.png

          # Android signing keystore (generated by server)
          aws s3 cp "${S3_BASE}/upload-keystore.jks" branding_assets/upload-keystore.jks || echo "No keystore found"

          # Firebase configs (optional)
          aws s3 cp "${S3_BASE}/google-services.json"      branding_assets/google-services.json      || echo "No google-services.json"
          aws s3 cp "${S3_BASE}/GoogleService-Info.plist"  branding_assets/GoogleService-Info.plist  || echo "No GoogleService-Info.plist"

          # Apple API key for iOS distribution (optional)
          aws s3 cp "${S3_BASE}/auth.p8" branding_assets/auth.p8 || echo "No auth.p8"

      # ── 2. Fetch Keystore Password from Secrets Manager ────────────────────
      - name: Fetch Keystore Password
        id: keystore
        run: |
          SECRET_NAME="white-label/${{ github.event.client_payload.client_id }}/keystore-password"
          PASSWORD=$(aws secretsmanager get-secret-value --secret-id "$SECRET_NAME" --query SecretString --output text)
          echo "::add-mask::$PASSWORD"
          echo "password=$PASSWORD" >> "$GITHUB_OUTPUT"

      # ── 3. Install Dependencies ───────────────────────────────────────────
      - name: Install Flutter Dependencies
        run: flutter pub get

      - name: Install Rebrand CLI Dependencies
        run: |
          cd rebrand_cli
          dart pub get

      # ── 4. Fastlane: Create App & Sync Signing (iOS) ──────────────────────
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: Install Fastlane
        run: gem install fastlane

      - name: Fastlane - Create App ID & Sync Certs
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_KEYCHAIN_NAME: "login.keychain"
          MATCH_KEYCHAIN_PASSWORD: "app-signing-password"
          APP_IDENTIFIER: ${{ github.event.client_payload.bundle_id }}
          APP_NAME: ${{ github.event.client_payload.app_name }}
          # Apple Authentication (using the downloaded p8 key)
          ASC_KEY_ID: ${{ github.event.client_payload.apple_key_id }}
          ASC_ISSUER_ID: ${{ github.event.client_payload.apple_issuer_id }}
          ASC_KEY_PATH: "branding_assets/auth.p8" 
        run: |
          # 1. Create App on Apple Developer Portal if not exists
          fastlane produce \
            --app_identifier "$APP_IDENTIFIER" \
            --app_name "$APP_NAME" \
            --username "unused_via_api_key" \
            --skip_itc true \
            --key_id "$ASC_KEY_ID" \
            --issuer_id "$ASC_ISSUER_ID" \
            --key_filepath "$ASC_KEY_PATH" || echo "App likely exists, continuing..."

          # 2. Sync Certificates & Profiles (ReadOnly = false to allow creation)
          fastlane match appstore \
            --app_identifier "$APP_IDENTIFIER" \
            --type "appstore" \
            --clone_branch_directly \
            --verbose \
            --readonly false \
            --key_id "$ASC_KEY_ID" \
            --issuer_id "$ASC_ISSUER_ID" \
            --key_filepath "$ASC_KEY_PATH"

      # ── 5. Run Rebrand CLI ────────────────────────────────────────────────
      - name: Run Rebrand CLI
        run: |
          dart rebrand_cli/bin/rebrand.dart \
            --name        "${{ github.event.client_payload.app_name }}" \
            --bundle-id   "${{ github.event.client_payload.bundle_id }}" \
            --asset-dir   "branding_assets" \
            --keystore-path "branding_assets/upload-keystore.jks" \
            --key-password  "${{ steps.keystore.outputs.password }}" \
            --key-alias     "${{ github.event.client_payload.android_key_alias }}" \
            --google-json   "branding_assets/google-services.json" \
            --google-plist  "branding_assets/GoogleService-Info.plist" \
            --apple-team-id   "${{ github.event.client_payload.apple_team_id }}" \
            --apple-issuer-id "${{ github.event.client_payload.apple_issuer_id }}" \
            --apple-key-id    "${{ github.event.client_payload.apple_key_id }}" \
            --p8-path         "branding_assets/auth.p8"

      # ── 4. Build Signed Android APK ───────────────────────────────────────
      - name: Build Signed Release APK
        run: flutter build apk --release

      # ── 5. Build Signed iOS IPA ───────────────────────────────────────────
      - name: Build iOS Archive
        if: ${{ github.event.client_payload.apple_team_id != '' }}
        run: |
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist || true

      # ── 6. Upload Artifacts ───────────────────────────────────────────────
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.client_id }}-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Upload IPA Artifact
        if: ${{ github.event.client_payload.apple_team_id != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.client_id }}-ipa
          path: build/ios/ipa/*.ipa

      # ── 7. Cleanup S3 Assets ──────────────────────────────────────────────
      # NOTE: The keystore (upload-keystore.jks) is intentionally kept in S3
      # so it can be reused for future app updates (same signing identity).
      - name: Cleanup S3 Assets
        if: always()
        run: |
          CLIENT_ID="${{ github.event.client_payload.client_id }}"
          S3_BASE="s3://${{ secrets.S3_BUCKET }}/brands/${CLIENT_ID}"
          aws s3 rm "${S3_BASE}/logo.png"
          aws s3 rm "${S3_BASE}/splash.png"
          aws s3 rm "${S3_BASE}/google-services.json"      || true
          aws s3 rm "${S3_BASE}/GoogleService-Info.plist"  || true
          aws s3 rm "${S3_BASE}/auth.p8"                   || true
          # upload-keystore.jks is preserved for future update builds
